<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Гранулометрический состав</title>
    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            padding: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><g fill="none" stroke="%23002f4b" stroke-opacity="0.05" stroke-width="3"><ellipse cx="30" cy="40" rx="5" ry="8"/><ellipse cx="120" cy="60" rx="7" ry="10"/><polygon points="170,90 180,100 160,100" /><ellipse cx="80" cy="140" rx="6" ry="4"/><polygon points="20,160 30,170 15,175" /><ellipse cx="150" cy="180" rx="4" ry="7"/><path d="M50,50 Q60,40 70,50 T90,50" /><path d="M100,120 Q110,130 120,120 T140,120" /></g></svg>');
            background-repeat: repeat;
            background-size: 200px;
        }

        .top-menu {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        .top-menu button {
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid #2c3e50;
            background-color: #2c3e50;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .top-menu button:hover {
            background-color: #34495e;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(44, 62, 80, 0.95);
            z-index: 20;
            padding-top: 60px;
            overflow: hidden;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .sidebar.open {
            visibility: visible;
            opacity: 1;
        }
        .sidebar button.close-btn {
            margin-bottom: 20px;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid #2c3e50;
            background-color: #2c3e50;
            color: white;
            cursor: pointer;
            font-size: 16px;
            width: 80%;
            max-width: 300px;
        }
        .sidebar a {
            display: block;
            color: white;
            padding: 15px 25px;
            margin: 5px 0;
            text-decoration: none;
            font-size: 18px;
            border-radius: 12px;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }
        .sidebar a:hover {
            background-color: #34495e;
        }

        .header-text {
            max-width: 800px;
            margin: 0 auto 30px;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        .header-text h1 {
            font-size: 24px;
            color: #2c3e50;
        }
        .header-text p {
            font-size: 16px;
            color: #e74c3c;
        }

        .tests-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .test-flex {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            gap: 15px;
            opacity: 0;
            transform: translateY(20px);
            animation: slideIn 0.5s ease forwards;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
        }

        .calculation-container {
            border: 2px solid #2c3e50;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.9);
            min-width: 500px;
            max-width: 800px;
            margin: 0 auto;
            display: block;
            box-sizing: border-box;
            position: relative;
        }

        .input-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .sieve-container, .hydrometer-container {
            flex: 1;
            min-width: 240px;
        }
        .input-section {
            margin-bottom: 15px;
        }
        .input-section h4 {
            margin: 0 0 8px;
            font-size: 16px;
            color: #2c3e50;
        }
        .input-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .input-row.sieve {
            flex-direction: column;
        }
        .input-row.hydrometer {
            flex-direction: column;
            gap: 8px;
        }
        .input-row.hydrometer .input-pair {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .input-row.hydrometer input.hydrometer-value {
            flex: 1 1 60%;
        }
        .input-row.hydrometer input.hydrometer-correction {
            flex: 0 0 120px;
            width: 120px;
        }
        .input-row.corrections {
            flex-direction: column;
            gap: 8px;
        }
        .input-row.corrections input {
            width: 100%;
        }
        .input-row input {
            width: 100%;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 13px;
        }

        .result-table {
            margin-top: 10px;
            width: 100%;
            border-collapse: separate;
            border-spacing: 2px;
        }
        .result-table th, .result-table td {
            border: 1px solid #d3dce6;
            padding: 6px;
            text-align: center;
            font-size: 12px;
            width: 80px;
        }
        .result-table th {
            color: #2c3e50;
            font-weight: bold;
        }
        .result-table td {
            color: #1a73e8;
            font-weight: bold;
        }
        .result-table td.result-Сумма.error {
            background-color: #ffcccc;
        }
        .result-table .action-row.results {
            text-align: right;
            padding: 8px 0;
        }
        .result-table .action-row.results td {
            border: none;
            padding: 0;
            text-align: right;
        }
        .btn-copy {
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid #4fc3f7;
            background-color: #4fc3f7;
            color: white;
            cursor: pointer;
            font-size: 14px;
            display: none;
            margin: 0;
        }
        .btn-copy.copied {
            background-color: #81c784;
            border-color: #81c784;
        }
        .btn-copy:hover {
            background-color: #29b6f6;
        }
        .btn-copy.copied:hover {
            background-color: #66bb6a;
        }

        .action-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .btn-calc-green {
            padding: 8px 14px;
            border-radius: 12px;
            border: 2px solid #2e7d32;
            background-color: #2e7d32;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-calc-green:hover {
            background-color: #388e3c;
        }

        .btn-clear {
            padding: 8px 14px;
            border-radius: 12px;
            border: 1px solid #7f8c8d;
            background-color: #ecf0f1;
            color: #2c3e50;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-clear:hover {
            background-color: #bdc3c7;
        }

        .btn-settings {
            padding: 8px 14px;
            border-radius: 12px;
            border: 2px solid #2c3e50;
            background-color: #2c3e50;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-settings:hover {
            background-color: #34495e;
        }

        .delete-btn {
            position: absolute;
            top: 0;
            right: -80px;
            padding: 6px 12px;
            border-radius: 10px;
            border: 1px solid #e74c3c;
            background-color: #e74c3c;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .delete-btn:hover {
            background-color: #c0392b;
        }

        .action-btn {
            padding: 10px 20px;
            border-radius: 14px;
            border: 2px solid #2c3e50;
            background-color: #2c3e50;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            margin: 0 10px;
        }
        .action-btn:hover {
            background-color: #34495e;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            justify-content: center;
            align-items: center;
        }
        .settings-modal.open {
            display: flex;
        }
        .settings-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .settings-content h3 {
            margin: 0 0 15px;
            font-size: 18px;
            color: #2c3e50;
        }
        .settings-content label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #2c3e50;
        }
        .settings-content select {
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        .settings-content input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-save {
            padding: 8px 14px;
            border-radius: 12px;
            border: 2px solid #2e7d32;
            background-color: #2e7d32;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-save:hover {
            background-color: #388e3c;
        }
        .btn-cancel {
            padding: 8px 14px;
            border-radius: 12px;
            border: 2px solid #7f8c8d;
            background-color: #7f8c8d;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-cancel:hover {
            background-color: #95a5a6;
        }

        .copy-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #2e7d32;
            color: white;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 40;
        }
        .copy-notification.show {
            opacity: 1;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media screen and (max-width: 768px) {
            body {
                padding-top: 60px;
            }
            .header-text {
                margin-top: 20px;
            }
            .test-flex {
                flex-direction: column;
                align-items: center;
            }
            .calculation-container {
                width: 100%;
                max-width: 90%;
                min-width: 320px;
                margin: 0 auto;
                box-sizing: border-box;
            }
            .delete-btn {
                position: static;
                margin-top: 10px;
                margin-left: 0;
                align-self: flex-end;
            }
            .input-container {
                flex-direction: column;
            }
            .sieve-container, .hydrometer-container {
                min-width: 100%;
            }
            .input-row.corrections {
                flex-direction: column;
            }
            .input-row.corrections input {
                width: 100%;
            }
            .result-table {
                font-size: 10px;
            }
            .result-table th, .result-table td {
                padding: 4px;
                width: auto;
            }
            .result-table .action-row.results {
                text-align: right;
                padding-right: 8px;
            }
            .btn-copy {
                margin: 0;
            }
        }

        @media screen and (max-width: 400px) {
            .calculation-container {
                min-width: 280px;
                max-width: 90%;
            }
            .result-table {
                font-size: 8px;
            }
            .result-table th, .result-table td {
                padding: 3px;
            }
            .btn-copy {
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="top-menu">
        <button onclick="App.navigate('index.html')" aria-label="Перейти на главную">🏠</button>
        <button onclick="App.toggleMenu()" aria-label="Открыть меню">☰ Меню</button>
    </div>

    <div class="sidebar" id="sidebar">
        <button class="close-btn" onclick="App.toggleMenu()" aria-label="Закрыть меню">Закрыть ×</button>
        <a href="vlazhnost.html">Влажность грунта</a>
        <a href="granulometr.html">Гранулометрический состав</a>
        <a href="plastichnost.html">Пределы пластичности</a>
        <a href="plotnost.html">Плотность грунта</a>
        <a href="organic.html">Содержание органических веществ</a>
        <a href="scale.html">Скальный грунт</a>
        <a href="contacts.html">Контакты</a>
        <a href="reference.html">Справочник</a>

    </div>

    <div class="header-text">
        <h1>Гранулометрический состав</h1>
        <p style="color: #000000;">Введите данные для расчета гранулометрического состава грунта в таблицу ниже. <br>Расчет ведется в соответствии с ГОСТ 12536-2014</p>
    </div>

    <div id="tests-container" class="tests-container"></div>

    <div style="text-align: center; margin-top: 25px;">
        <button class="action-btn" onclick="App.addTest()" aria-label="Добавить новое испытание">+ Добавить испытание</button>
    </div>

    <div class="settings-modal" id="settings-modal">
        <div class="settings-content">
            <h3>Настройки</h3>
            <label><input type="checkbox" id="setting-add-2-1mm"> Добавить фракцию 2-1 мм в навеску для ареометра</label>
            <label><input type="checkbox" id="setting-combine-10-2mm"> Объединить фракции 10-5 и 5-2 мм</label>
            <label><input type="checkbox" id="setting-combine-0_01-0_002mm"> Объединить фракции 0.01-0.005 и 0.005-0.002 мм</label>
            <label>
                Округление результатов:
                <select id="setting-rounding">
                    <option value="0">Целое число</option>
                    <option value="1" selected>1 знак после запятой</option>
                    <option value="2">2 знака после запятой</option>
                </select>
            </label>
            <div class="settings-actions">
                <button class="btn-save" onclick="App.saveSettings()" aria-label="Сохранить настройки">Сохранить</button>
                <button class="btn-cancel" onclick="App.closeSettings()" aria-label="Отмена">Отмена</button>
            </div>
        </div>
    </div>

    <div class="copy-notification" id="copy-notification">Скопировано!</div>

    <script>
        const App = {
            settings: {
                add2_1mm: true,
                combine10_2mm: true,
                combine0_01_0_002mm: true,
                rounding: 1
            },

            init() {
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('Granulometric page loaded');
                    this.addTest();
                });
            },

            toggleMenu() {
                document.getElementById("sidebar").classList.toggle("open");
            },

            navigate(url) {
                location.href = url;
            },

            addTest() {
                const container = document.getElementById("tests-container");
                const testFlex = document.createElement("div");
                testFlex.classList.add("test-flex");

                const calcDiv = document.createElement("div");
                calcDiv.classList.add("calculation-container");

                const sieveInputs = this.settings.combine10_2mm
                    ? `<input type="number" step="any" class="frac-10-2mm" placeholder="10-2 мм, г" aria-label="Фракция 10-2 мм">`
                    : `
                        <input type="number" step="any" class="frac-10-5mm" placeholder="10-5 мм, г" aria-label="Фракция 10-5 мм">
                        <input type="number" step="any" class="frac-5-2mm" placeholder="5-2 мм, г" aria-label="Фракция 5-2 мм">
                    `;
                const fractionHeaders = this.settings.combine10_2mm
                    ? ['>10', '10-2', '2-1', '1-0_5', '0_5-0_25', '0_25-0_1', '0_1-0_05', '0_05-0_01']
                    : ['>10', '10-5', '5-2', '2-1', '1-0_5', '0_5-0_25', '0_25-0_1', '0_1-0_05'];
                const fractionHeadersFine = this.settings.combine0_01_0_002mm
                    ? ['0_01-0_002']
                    : ['0_01-0_005', '0_005-0_002'];
                const allFractionHeaders = [...fractionHeaders, ...fractionHeadersFine, '<0_002', 'Сумма'];

                calcDiv.innerHTML = `
                    <div class="input-section">
                        <h4>Общий вес пробы</h4>
                        <div class="input-row">
                            <input type="number" step="any" class="total-weight" placeholder="Общий вес пробы, г" aria-label="Общий вес пробы">
                        </div>
                    </div>
                    <div class="input-container">
                        <div class="sieve-container">
                            <div class="input-section">
                                <h4>Ситовой рассев, г</h4>
                                <div class="input-row sieve">
                                    <input type="number" step="any" class="frac-over-10mm" placeholder=">10 мм, г" aria-label="Фракция >10 мм">
                                    ${sieveInputs}
                                    <input type="number" step="any" class="frac-2-1mm" placeholder="2-1 мм, г" aria-label="Фракция 2-1 мм">
                                    <input type="number" step="any" class="frac-1-0_5mm" placeholder="1-0.5 мм, г" aria-label="Фракция 1-0.5 мм">
                                    <input type="number" step="any" class="frac-0_5-0_25mm" placeholder="0.5-0.25 мм, г" aria-label="Фракция 0.5-0.25 мм">
                                    <input type="number" step="any" class="frac-0_25-0_1mm" placeholder="0.25-0.1 мм, г" aria-label="Фракция 0.25-0.1 мм">
                                </div>
                            </div>
                        </div>
                        <div class="hydrometer-container">
                            <div class="input-section">
                                <h4>Ареометрический анализ, г/л</h4>
                                <div class="input-row hydrometer">
                                    <div class="input-pair">
                                        <input type="number" step="any" class="hydrometer-value hydrometer-1min" placeholder="Ареометр, 1 мин" aria-label="Показание ареометра через 1 минуту">
                                        <input type="number" step="any" class="hydrometer-correction hydrometer-correction-1min" placeholder="Поправка, г/л" aria-label="Поправка для ареометра 1 минута">
                                    </div>
                                    <div class="input-pair">
                                        <input type="number" step="any" class="hydrometer-value hydrometer-30min" placeholder="Ареометр, 30 мин" aria-label="Показание ареометра через 30 минут">
                                        <input type="number" step="any" class="hydrometer-correction hydrometer-correction-30min" placeholder="Поправка, г/л" aria-label="Поправка для ареометра 30 минут">
                                    </div>
                                    <div class="input-pair">
                                        <input type="number" step="any" class="hydrometer-value hydrometer-11h" placeholder="Ареометр, 11 ч" aria-label="Показание ареометра через 11 часов">
                                        <input type="number" step="any" class="hydrometer-correction hydrometer-correction-11h" placeholder="Поправка, г/л" aria-label="Поправка для ареометра 11 часов">
                                    </div>
                                </div>
                            </div>
                            <div class="input-section">
                                <h4>Дополнительные параметры</h4>
                                <div class="input-row corrections">
                                    <input type="number" step="any" class="hydrometer-sample" placeholder="Масса навески, г" aria-label="Масса навески для ареометра">
                                    <input type="number" step="any" class="particle-density" placeholder="Плотность частиц грунта, г/см³" aria-label="Плотность частиц грунта">
                                </div>
                            </div>
                        </div>
                    </div>
                    <table class="result-table">
                        <tr>
                            ${allFractionHeaders.map(header => `<th>${header.replace(/_/g, '.')}</th>`).join('')}
                        </tr>
                        <tr>
                            ${allFractionHeaders.map(header => `<td class="result-${header}">-</td>`).join('')}
                        </tr>
                        <tr class="action-row results">
                            <td colspan="${allFractionHeaders.length}" style="text-align: right;">
                                <button class="btn-copy" onclick="App.copyResults(this)" aria-label="Скопировать результаты">Скопировать</button>
                            </td>
                        </tr>
                    </table>
                    <div class="action-row">
                        <div>
                            <button class="btn-calc-green" onclick="App.calculateTest(this)" aria-label="Рассчитать гранулометрический состав">Рассчитать</button>
                            <button class="btn-clear" onclick="App.clearTest(this)" aria-label="Очистить поля">Очистить</button>
                            <button class="btn-settings" onclick="App.openSettings()" aria-label="Открыть настройки">Настройки⚙️</button>
                        </div>
                    </div>
                `;

                testFlex.appendChild(calcDiv);
                testFlex.appendChild(document.createElement("button"));
                testFlex.lastChild.classList.add("delete-btn");
                testFlex.lastChild.textContent = "Удалить";
                testFlex.lastChild.setAttribute("aria-label", "Удалить испытание");
                testFlex.lastChild.onclick = () => testFlex.remove();
                container.appendChild(testFlex);

                this.setupEnterNavigation(calcDiv);
            },

            openSettings() {
                const modal = document.getElementById("settings-modal");
                document.getElementById("setting-add-2-1mm").checked = this.settings.add2_1mm;
                document.getElementById("setting-combine-10-2mm").checked = this.settings.combine10_2mm;
                document.getElementById("setting-combine-0_01-0_002mm").checked = this.settings.combine0_01_0_002mm;
                document.getElementById("setting-rounding").value = this.settings.rounding;
                modal.classList.add("open");
            },

            saveSettings() {
                this.settings.add2_1mm = document.getElementById("setting-add-2-1mm").checked;
                this.settings.combine10_2mm = document.getElementById("setting-combine-10-2mm").checked;
                this.settings.combine0_01_0_002mm = document.getElementById("setting-combine-0_01-0_002mm").checked;
                this.settings.rounding = parseInt(document.getElementById("setting-rounding").value);

                const container = document.getElementById("tests-container");
                const tests = Array.from(container.querySelectorAll(".test-flex"));
                container.innerHTML = "";
                tests.forEach(() => this.addTest());

                document.getElementById("settings-modal").classList.remove("open");
            },

            closeSettings() {
                document.getElementById("settings-modal").classList.remove("open");
            },

            clearTest(btn) {
                const calcDiv = btn.closest(".calculation-container");
                calcDiv.querySelectorAll("input").forEach(input => input.value = "");
                calcDiv.querySelectorAll(".result-table td:not(.action-row td)").forEach(td => {
                    td.textContent = "-";
                    td.classList.remove("error");
                });
                calcDiv.querySelector(".btn-copy").style.display = "none";
            },

            calculateTest(btn) {
                const calcDiv = btn.closest(".calculation-container");
                const getValue = (selector) => {
                    const value = parseFloat(calcDiv.querySelector(selector).value) || 0;
                    console.log(`Reading ${selector}: ${value}`);
                    return value;
                };

                // Input values
                const totalWeight = getValue(".total-weight");
                const fracOver10mm = getValue(".frac-over-10mm");
                const frac10_5mm = this.settings.combine10_2mm ? 0 : getValue(".frac-10-5mm");
                const frac5_2mm = this.settings.combine10_2mm ? 0 : getValue(".frac-5-2mm");
                const frac10_2mm = this.settings.combine10_2mm ? getValue(".frac-10-2mm") : 0;
                const frac2_1mm = getValue(".frac-2-1mm");
                const frac1_0_5mm = getValue(".frac-1-0_5mm");
                const frac0_5_0_25mm = getValue(".frac-0_5-0_25mm");
                const frac0_25_0_1mm = getValue(".frac-0_25-0_1mm");
                const hydrometerSample = getValue(".hydrometer-sample");
                const particleDensity = getValue(".particle-density");
                const correction1min = getValue(".hydrometer-correction-1min");
                const correction30min = getValue(".hydrometer-correction-30min");
                const correction11h = getValue(".hydrometer-correction-11h");
                const hydrometer1min = getValue(".hydrometer-1min") + correction1min;
                const hydrometer30min = getValue(".hydrometer-30min") + correction30min;
                const hydrometer11h = getValue(".hydrometer-11h") + correction11h;

                console.log('Hydrometer values with corrections:', { hydrometer1min, hydrometer30min, hydrometer11h });

                // Validation
                if (totalWeight <= 0) {
                    alert("Ошибка: Общий вес пробы должен быть больше 0");
                    console.log("Validation failed: totalWeight <= 0");
                    return;
                }
                if (hydrometerSample <= 0 && (frac2_1mm > 0 || frac1_0_5mm > 0 || frac0_5_0_25mm > 0 || frac0_25_0_1mm > 0 || hydrometer1min > 0 || hydrometer30min > 0 || hydrometer11h > 0)) {
                    alert("Ошибка: Масса навески должна быть больше 0, если введены данные для ситового или ареометрического анализа");
                    console.log("Validation failed: hydrometerSample <= 0 with non-zero inputs");
                    return;
                }
                if (particleDensity <= 1 && (hydrometer1min > 0 || hydrometer30min > 0 || hydrometer11h > 0)) {
                    alert("Ошибка: Плотность частиц грунта должна быть больше 1 для ареометрических расчётов");
                    console.log("Validation failed: particleDensity <= 1 with hydrometer data");
                    return;
                }

                // Calculate fractions with high precision
                const results = {};
                results['>10'] = totalWeight > 0 ? (fracOver10mm * 100) / totalWeight : 0;
                console.log(`Raw >10: ${results['>10']}`);
                if (this.settings.combine10_2mm) {
                    results['10-2'] = totalWeight > 0 ? (frac10_2mm * 100) / totalWeight : 0;
                    console.log(`Raw 10-2: ${results['10-2']}`);
                } else {
                    results['10-5'] = totalWeight > 0 ? (frac10_5mm * 100) / totalWeight : 0;
                    results['5-2'] = totalWeight > 0 ? (frac5_2mm * 100) / totalWeight : 0;
                    console.log(`Raw 10-5: ${results['10-5']}, 5-2: ${results['5-2']}`);
                }

                // Sum of coarse fractions
                const coarseSum = (this.settings.combine10_2mm
                    ? results['>10'] + results['10-2']
                    : results['>10'] + results['10-5'] + results['5-2']) || 0;
                console.log(`Coarse sum: ${coarseSum}`);

                // Calculate 2-1 mm fraction
                if (this.settings.add2_1mm) {
                    results['2-1'] = hydrometerSample > 0 ? (frac2_1mm * (100 - coarseSum)) / hydrometerSample : 0;
                } else {
                    results['2-1'] = totalWeight > 0 ? (frac2_1mm * 100) / totalWeight : 0;
                }
                console.log(`Raw 2-1: ${results['2-1']}`);

                // Calculate other sieve fractions
                results['1-0_5'] = hydrometerSample > 0 ? (frac1_0_5mm * (100 - coarseSum)) / hydrometerSample : 0;
                results['0_5-0_25'] = hydrometerSample > 0 ? (frac0_5_0_25mm * (100 - coarseSum)) / hydrometerSample : 0;
                results['0_25-0_1'] = hydrometerSample > 0 ? (frac0_25_0_1mm * (100 - coarseSum)) / hydrometerSample : 0;
                console.log(`Raw 1-0_5: ${results['1-0_5']}, 0_5-0_25: ${results['0_5-0_25']}, 0_25-0_1: ${results['0_25-0_1']}`);

                // Hidden calculations for hydrometer
                const hidden1min = (particleDensity > 1 && hydrometerSample > 0) ? (particleDensity * (100 - coarseSum) * hydrometer1min) / ((particleDensity - 1) * hydrometerSample) : 0;
                const hidden30min = (particleDensity > 1 && hydrometerSample > 0) ? (particleDensity * (100 - coarseSum) * hydrometer30min) / ((particleDensity - 1) * hydrometerSample) : 0;
                const hidden11h = (particleDensity > 1 && hydrometerSample > 0) ? (particleDensity * (100 - coarseSum) * hydrometer11h) / ((particleDensity - 1) * hydrometerSample) : 0;
                console.log(`Hidden calculations: 1min: ${hidden1min}, 30min: ${hidden30min}, 11h: ${hidden11h}`);

                // Calculate fine fractions
                results['0_1-0_05'] = 100 - (results['>10'] + (this.settings.combine10_2mm ? results['10-2'] : (results['10-5'] + results['5-2'])) + results['2-1'] + results['1-0_5'] + results['0_5-0_25'] + results['0_25-0_1'] + hidden1min);
                results['0_05-0_01'] = hidden1min - hidden30min;
                if (this.settings.combine0_01_0_002mm) {
                    results['0_01-0_002'] = hidden30min - hidden11h;
                } else {
                    results['0_01-0_005'] = (hidden30min - hidden11h) * 0.5;
                    results['0_005-0_002'] = (hidden30min - hidden11h) * 0.5;
                }
                results['<0_002'] = hidden11h;
                console.log(`Raw fine fractions: 0_1-0_05: ${results['0_1-0_05']}, 0_05-0_01: ${results['0_05-0_01']}, 0_01-0_002: ${results['0_01-0_002'] || ''}, 0_01-0_005: ${results['0_01-0_005'] || ''}, 0_005-0_002: ${results['0_005-0_002'] || ''}, <0_002: ${results['<0_002']}`);

                // Handle NaN or negative values
                Object.keys(results).forEach(key => {
                    if (isNaN(results[key]) || results[key] < 0) {
                        console.log(`Adjusting ${key}: ${results[key]} to 0 (NaN or negative)`);
                        results[key] = 0;
                    }
                });

                // Round results
                const rounding = this.settings.rounding;
                const roundedResults = {};
                Object.keys(results).forEach(key => {
                    roundedResults[key] = Number(results[key].toFixed(rounding));
                    console.log(`Rounded ${key}: ${roundedResults[key]}`);
                });

                // Adjust smallest fractions to ensure sum is exactly 100
                const fineFractions = this.settings.combine0_01_0_002mm
                    ? ['<0_002', '0_01-0_002', '0_05-0_01', '0_1-0_05']
                    : ['<0_002', '0_005-0_002', '0_01-0_005', '0_05-0_01', '0_1-0_05'];
                let sum = Object.keys(roundedResults).filter(k => k !== 'Сумма').reduce((acc, key) => acc + roundedResults[key], 0);
                console.log(`Sum before adjustment: ${sum}`);

                const targetSum = 100;
                const tolerance = 0.1 ** rounding;
                let iteration = 0;
                const maxIterations = 100;
                while (Math.abs(sum - targetSum) > tolerance && iteration < maxIterations) {
                    const diff = targetSum - sum;
                    const keys = fineFractions.filter(k => roundedResults[k] > 0).sort((a, b) => roundedResults[a] - roundedResults[b]);
                    console.log(`Iteration ${iteration + 1}, Sum: ${sum}, Diff: ${diff}, Adjustable fractions: ${keys}`);
                    if (keys.length === 0) break;
                    const step = 0.1 ** rounding;
                    const adjustment = Math.sign(diff) * Math.min(Math.abs(diff), step);
                    const key = keys[0];
                    roundedResults[key] += adjustment;
                    roundedResults[key] = Number(roundedResults[key].toFixed(rounding));
                    console.log(`Adjusted ${key} by ${adjustment} to ${roundedResults[key]}`);
                    sum = Object.keys(roundedResults).filter(k => k !== 'Сумма').reduce((acc, key) => acc + roundedResults[key], 0);
                    console.log(`New sum: ${sum}`);
                    iteration++;
                }

                // Final sum
                roundedResults['Сумма'] = Number(sum.toFixed(rounding));
                const sumError = Math.abs(roundedResults['Сумма'] - 100) > tolerance;
                if (sumError) {
                    alert(`Ошибка: Сумма фракций (${roundedResults['Сумма']}) не равна 100. Проверьте введённые данные.`);
                    console.log(`Sum error: ${roundedResults['Сумма']} != 100`);
                }
                console.log(`Final sum after adjustment: ${roundedResults['Сумма']}`);

                // Log final results
                console.log('Final rounded results:', roundedResults);

                // Update table
                calcDiv.querySelectorAll(".result-table td:not(.action-row td)").forEach(td => {
                    const fraction = td.className.replace('result-', '');
                    td.textContent = roundedResults[fraction] !== undefined && !isNaN(roundedResults[fraction]) 
                        ? (fraction === 'Сумма' ? `${roundedResults[fraction].toFixed(rounding)}%` : roundedResults[fraction]) 
                        : "-";
                    if (fraction === 'Сумма') {
                        td.classList.toggle('error', sumError);
                    } else {
                        td.classList.remove("error");
                    }
                    console.log(`Updating cell for ${fraction}: ${td.textContent}`);
                });

                // Show copy button
                const copyBtn = calcDiv.querySelector(".btn-copy");
                console.log('Showing copy button');
                copyBtn.style.display = "block";
                copyBtn.classList.remove("copied");
                copyBtn.innerHTML = "Скопировать";
            },

            copyResults(btn) {
                const calcDiv = btn.closest(".calculation-container");
                const results = calcDiv.querySelectorAll(".result-table td:not(.action-row td)");
                const values = Array.from(results).map(td => td.textContent.trim());
                console.log('Copying values:', values);
                const text = values.join("\t");
                navigator.clipboard.writeText(text).then(() => {
                    btn.classList.add("copied");
                    btn.innerHTML = "Скопировано! ✅";
                    const notification = document.getElementById("copy-notification");
                    notification.classList.add("show");
                    setTimeout(() => {
                        notification.classList.remove("show");
                        btn.classList.remove("copied");
                        btn.innerHTML = "Скопировать";
                    }, 2000);
                }).catch(err => {
                    console.error("Copy error:", err);
                    alert("Ошибка при копировании");
                });
            },

            setupEnterNavigation(calcDiv) {
                const inputs = Array.from(calcDiv.querySelectorAll('input[type="number"]'));
                console.log(`Setting up Enter navigation for ${inputs.length} inputs:`, inputs.map(input => input.className));

                inputs.forEach(input => {
                    if (input._handleEnterKey) {
                        input.removeEventListener("keydown", input._handleEnterKey);
                        input._handleEnterKey = null;
                    }
                });

                const handleEnterKey = (event) => {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        const currentIndex = inputs.indexOf(event.target);
                        console.log(`Enter pressed on input ${currentIndex + 1}: ${event.target.className}`);

                        if (currentIndex < inputs.length - 1) {
                            console.log(`Focusing next input: ${currentIndex + 2} (${inputs[currentIndex + 1].className})`);
                            inputs[currentIndex + 1].focus();
                        } else {
                            console.log("Triggering calculateTest for last input");
                            const calcButton = calcDiv.querySelector(".btn-calc-green");
                            if (calcButton) {
                                calcButton.click();
                            }
                        }
                    }
                };

                inputs.forEach(input => {
                    input._handleEnterKey = handleEnterKey;
                    input.addEventListener("keydown", handleEnterKey);
                });
            }
        };

        App.init();
    </script>
</body>
</html>